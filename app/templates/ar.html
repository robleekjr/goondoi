{% extends "base.html" %}

{% block title %}Cassowary AR Experience{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card bg-success bg-opacity-10 border-0 shadow">
                <div class="card-body text-center">
                    <h2 class="mb-3">Cassowary AR Experience</h2>
                    <p>Point your camera at a QR code to anchor the cassowary, then watch it walk across the spot!</p>
                    <div id="ar-container" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #2e7d32 60%, #a5d6a7 100%); border-radius: 1rem; overflow: hidden;">
                        <video id="ar-video" autoplay playsinline style="display:none;"></video>
                        <canvas id="ar-canvas" style="width: 100%; height: auto; border-radius: 1rem;"></canvas>
                        <!-- Hidden video for animation -->
                        <video id="cassowary-video" src="{{ url_for('static', filename='images/1752210831_Cassowary_to_Human_Animation_Request.mp4') }}" loop muted playsinline style="display:none;"></video>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="startAR()">Start AR</button>
                        <button class="btn btn-secondary ms-2" id="reset-ar-btn" onclick="resetAR()" style="display:none;">Reset AR</button>
                    </div>
                    <div id="ar-error" class="text-danger mt-2" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load jsQR from CDN -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let arStream = null;
let animationFrame = null;
let cassowaryVideo = null;

// Animation state
let anchor = null; // {centerX, centerY, angle, boxWidth, boxHeight}
let cassowaryX = null;
let animationActive = false;
let showBoundingBox = true;
let lastSeen = 0;

function startAR() {
    const video = document.getElementById('ar-video');
    const canvas = document.getElementById('ar-canvas');
    const ctx = canvas.getContext('2d');
    const errorDiv = document.getElementById('ar-error');
    const resetBtn = document.getElementById('reset-ar-btn');
    cassowaryVideo = document.getElementById('cassowary-video');
    errorDiv.style.display = 'none';

    anchor = null;
    cassowaryX = null;
    animationActive = false;
    showBoundingBox = true;
    resetBtn.style.display = 'none';
    lastSeen = 0;

    // Prepare the animation video
    cassowaryVideo.currentTime = 0;
    cassowaryVideo.pause();
    cassowaryVideo.load();

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
        .then(function(stream) {
            arStream = stream;
            video.srcObject = stream;
            video.onloadedmetadata = function() {
                video.play();
                // Set canvas size to match video
                video.width = video.videoWidth;
                video.height = video.videoHeight;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
                scanFrame();
            };
        })
        .catch(function(err) {
            errorDiv.textContent = 'Camera access denied or not available.';
            errorDiv.style.display = 'block';
        });

    function scanFrame() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });
            if (code) {
                // Save anchor info for this frame
                let centerX = (code.location.topLeftCorner.x + code.location.bottomRightCorner.x) / 2;
                let centerY = (code.location.topLeftCorner.y + code.location.bottomRightCorner.y) / 2;
                let boxWidth = Math.hypot(code.location.topRightCorner.x - code.location.topLeftCorner.x, code.location.topRightCorner.y - code.location.topLeftCorner.y);
                let boxHeight = Math.hypot(code.location.bottomLeftCorner.x - code.location.topLeftCorner.x, code.location.bottomLeftCorner.y - code.location.topLeftCorner.y);
                let angle = Math.atan2(code.location.topRightCorner.y - code.location.topLeftCorner.y, code.location.topRightCorner.x - code.location.topLeftCorner.x);
                if (!anchor) {
                    // First detection: initialize animation
                    anchor = {centerX, centerY, angle, boxWidth, boxHeight};
                    cassowaryX = -boxWidth * 1.2;
                } else {
                    // Update anchor to follow QR code
                    anchor.centerX = centerX;
                    anchor.centerY = centerY;
                    anchor.angle = angle;
                    anchor.boxWidth = boxWidth;
                    anchor.boxHeight = boxHeight;
                }
                showBoundingBox = false;
                resetBtn.style.display = 'inline-block';
                // Play the animation video if not already playing
                if (cassowaryVideo.paused) cassowaryVideo.play();
                animationActive = true;
                lastSeen = Date.now();
            } else {
                // QR code not detected
                animationActive = false;
                if (!cassowaryVideo.paused) cassowaryVideo.pause();
            }
            // Draw animation if active
            if (anchor && animationActive) {
                // Animate cassowary from left to right
                cassowaryX += 2; // speed in pixels per frame
                let maxX = anchor.boxWidth * 1.2;
                if (cassowaryX > maxX) {
                    cassowaryX = -anchor.boxWidth * 1.2; // loop animation
                }
                // Draw cassowary video at (anchor.centerX + cassowaryX, anchor.centerY)
                ctx.save();
                ctx.translate(anchor.centerX, anchor.centerY);
                ctx.rotate(anchor.angle);
                let vidWidth = anchor.boxWidth * 1.2;
                let vidHeight = anchor.boxHeight * 1.2;
                if (cassowaryVideo.readyState >= 2) {
                    ctx.drawImage(cassowaryVideo, cassowaryX - vidWidth/2, -vidHeight/2, vidWidth, vidHeight);
                }
                ctx.restore();
            }
        }
        animationFrame = requestAnimationFrame(scanFrame);
    }
}

function resetAR() {
    // Stop animation and scanning
    animationActive = false;
    anchor = null;
    cassowaryX = null;
    showBoundingBox = true;
    if (cassowaryVideo) {
        cassowaryVideo.pause();
        cassowaryVideo.currentTime = 0;
    }
    const resetBtn = document.getElementById('reset-ar-btn');
    resetBtn.style.display = 'none';
    // Restart AR scanning
    startAR();
}

window.addEventListener('beforeunload', () => {
    if (arStream) {
        arStream.getTracks().forEach(track => track.stop());
    }
    if (animationFrame) {
        cancelAnimationFrame(animationFrame);
    }
    if (cassowaryVideo) {
        cassowaryVideo.pause();
    }
});
</script>
{% endblock %} 